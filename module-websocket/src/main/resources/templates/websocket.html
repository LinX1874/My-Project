<!DOCTYPE html>
<html xmlns="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8"/>
    <title>Title</title>
</head>
<body>
<div>
    <label>token:</label>
    <input type="text" id="token"/>
    <button onclick="connect()" id="connect">连接</button>
    <button onclick="disconnect()" id="disconnect">断开</button>
</div>
<div>
    <label>msg:</label>
    <input type="text" id="name"/>
    <button id="sendBroadcast" onclick="sendAll()">群发所有</button>
    <div>
        <label>单发给用户:</label>
        <input type="text" id="to" placeholder="填写用户名"/>
        <button id="sendSingle" onclick="sendSingle()">单独发送</button>
    </div>
    <hr/>
    <div id="result" style="overFlow-y:scroll; width:550px; height: 400px; border: solid black;">
        <div id="msg"></div>
        <a id="end"></a>
    </div>
</div>

<script>
    var socket;

    function connect() {

        if (typeof(WebSocket) == "undefined") {
            console.log("您的浏览器不支持WebSocket");
        } else {
            console.log("您的浏览器支持WebSocket");
            var token = document.getElementById("token").value;
            socket = new WebSocket("ws://localhost:8080/endpoint/" + token);
            console.log(socket);
            //打开事件
            socket.onopen = function () {
                console.log("Socket 已打开");
                //socket.send("这是来自客户端的消息" + location.href + new Date());
            };
            //获得消息事件
            socket.onmessage = function (ret) {
                console.log(ret);
                //发现消息进入    调后台获取
                var msgDom = document.getElementById("msg");
                var html = msgDom.innerHTML;
                var jsonObject = JSON.parse(ret.data);
                msgDom.innerHTML = html + '<p> 【' + jsonObject.from + '】 ' + jsonObject.msg + '</p>';
                var div = document.getElementById("result");
                div.scrollTop = div.scrollHeight;
            };
            //关闭事件
            socket.onclose = function () {
                console.log("Socket已关闭");
            };
            //发生了错误事件
            socket.onerror = function () {
                alert("Socket发生了错误");
            };
            window.unload = function () {
                socket.close();
            };
        }
    }

    function disconnect() {
        if (socket != null) {
            socket.close();
        }
    }

    function sendSingle() {
        var name = document.getElementById("name").value;
        var to = document.getElementById("to").value;
        if (!socket) {
            alert('未连接!');
            return;
        }
        if (!to) {
            alert('填写单发用户名');
            return;
        }
        socket.send(JSON.stringify({
            'type': 0,
            'msg': name,
            'to': to
        }));
    }

    function sendAll() {
        var name = document.getElementById("name").value;
        if (!socket) {
            alert('未连接!');
            return;
        }
        socket.send(JSON.stringify({
            'type': 1,
            'msg': name,
        }));
    }

</script>
</body>
</html>