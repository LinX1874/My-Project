<!DOCTYPE html>
<html xmlns="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8"/>
    <title>Title</title>
</head>
<body>
<div id="app">
    <div>
        <label>token:</label>
        <input style="width:300px" type="text" v-model="token" placeholder="登录验证时的token，访客用户随便填写一个"/>
        <button @click="doConnect" v-show="!isConnected">连接</button>
        <button @click="doDisConnect" v-show="isConnected">断开</button>
    </div>
    <div>

        <hr/>
        <div id="result" style="overFlow-y:scroll; width:550px; height: 400px; border: solid black;">
            <div id="retMsg" v-html="resultMsg"></div>
            <a id="end"></a>
        </div>
        <hr/>
        <label>发送: </label>
        <input style="width:300px" type="text" v-model="sendText"/>
        <button id="sendBroadcast" @click="sendAll" v-show="isConnected">群发所有</button>
        <div>
            <label>单发给用户:</label>
            <input type="text" v-model="sendTo" placeholder="填写用户名"/>
            <input type="text" v-model="singleSendText" placeholder="单发内容"/>
            <button id="sendSingle" @click="sendSingle" v-show="isConnected">单独发送</button>
        </div>
    </div>

</div>

<script src="https://cdn.bootcss.com/vue/2.5.17-beta.0/vue.min.js"></script>
<script>
    var app = new Vue(
        {
            el: '#app',
            data: {
                isConnected: false,
                socket: null,
                token: '',
                sendText: '',
                singleSendText: '',
                sendTo: null,
                resultMsg: ''
            },
            computed: {
                wsUrl: function () {
                    return 'ws://' + window.location.host + '/endpoint/' + this.token;
                }
            },
            methods: {
                doConnect: function () {
                    if (typeof(WebSocket) == "undefined") {
                        console.log("您的浏览器不支持WebSocket");
                    } else {
                        if (!this.token) {
                            alert('填写你的token');
                            return;
                        }
                        this.socket = new WebSocket(this.wsUrl);
                        const that = this;
                        this.socket.onopen = function () {
                            that.isConnected = true;
                        };
                        this.socket.onmessage = function (ret) {
                            console.log(ret);
                            //发现消息进入    调后台获取
                            var msgDom = document.getElementById("retMsg");
                            var html = msgDom.innerHTML;
                            var json = JSON.parse(ret.data);
                            that.addText(json.type, json.msg, json.to, json.from);
                            // msgDom.innerHTML = html + '<p> 【' + json.from + '】 ' + json.msg + '</p>';
                            var div = document.getElementById("result");
                            div.scrollTop = div.scrollHeight;
                        };
                        //关闭事件
                        this.socket.onclose = function () {
                            that.isConnected = false;
                        };
                        //发生了错误事件
                        this.socket.onerror = function () {
                            that.isConnected = false;
                        };
                        window.unload = function () {
                            that.socket.close();
                        };
                    }
                },
                doDisConnect: function () {
                    if (this.socket != null) {
                        this.socket.close();
                    }
                },
                sendSingle: function () {
                    if (!this.sendTo) {
                        alert('填写你要发给谁');
                        return;
                    }
                    if(!this.singleSendText){
                        alert('发送内容不能为空');
                        return;
                    }
                    this.addText('SELF', this.singleSendText, '单发', '自己');
                    this.send(0, this.singleSendText, this.sendTo);
                    this.singleSendText = "";
                },
                sendAll: function () {
                    if(!this.sendText){
                        alert('发送内容不能为空');
                        return;
                    }
                    this.addText('SELF', this.sendText, '群发', '自己');
                    this.send(1, this.sendText);
                    this.sendText = "";
                },
                addText: function (type, msg, to, fromWho) {
                    this.resultMsg += '<p>【' + fromWho + '】 ' + msg + '</p>';
                },
                send: function (type, msg, to) {
                    this.socket.send(JSON.stringify({
                        'type': type,
                        'msg': msg,
                        'to': to
                    }))
                }
            }
        }
    )

</script>
</body>
</html>